name: Keep Backend Alive

on:
  schedule:
    # Run every 10 minutes to prevent Render free tier from sleeping
    # Render free tier spins down after 15 minutes of inactivity
    # Note: GitHub Actions scheduled workflows may be delayed during high load
    - cron: "*/10 * * * *"

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  ping:
    if: false # Workflow disabled
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Optimized timeout to handle Render free tier cold starts (20-90 seconds)
    # Strategy: 5 retries √ó 20s timeout + linear backoff (5s, 10s, 15s, 20s)
    # Total max wait: ~1.5 minutes for faster cold start detection

    steps:
      - name: Validate Backend URL Secret
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "‚ùå Error: BACKEND_URL secret is not set in GitHub repository settings"
            echo "Please set BACKEND_URL secret under Settings > Secrets and variables > Actions"
            exit 1
          fi
          echo "‚úÖ BACKEND_URL secret is configured"
          echo "üìç Backend URL: ${{ secrets.BACKEND_URL }}"

      - name: Ping Backend Keep-Alive Endpoint
        id: ping
        run: |
          # Track total workflow timing
          WORKFLOW_START=$(date +%s)
          echo "========================================="
          echo "üèì Pinging backend at $(date)"
          echo "========================================="

          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          ENDPOINT="${BACKEND_URL}/api/ping"
          MAX_RETRIES=5
          INITIAL_DELAY=5
          DELAY_INCREMENT=5
          CURL_TIMEOUT=20
          SUCCESS=false
          COLD_START=false
          TOTAL_RETRY_DELAY=0
          TOTAL_ATTEMPTS=0

          # Function to ping with retry logic and linear backoff
          # Optimized to handle Render free tier cold starts (20-90 seconds)
          ping_with_retry() {
            local attempt=1
            local delay=$INITIAL_DELAY
            
            while [ $attempt -le $MAX_RETRIES ]; do
              ATTEMPT_START=$(date +%s)
              echo ""
              echo "Attempt $attempt of $MAX_RETRIES at $(date +%H:%M:%S)..."
              
              # Create temp file for response body
              temp_file=$(mktemp)
              
              # Make request with timeout and capture response code, time, and body in one call
              # curl writes: body to file, then status code and time to stdout
              curl_output=$(curl -s -w "\n%{http_code}\n%{time_total}" \
                --max-time $CURL_TIMEOUT \
                --silent \
                --show-error \
                -o "$temp_file" \
                "${ENDPOINT}" 2>&1)
              
              curl_exit_code=$?
              ATTEMPT_END=$(date +%s)
              ATTEMPT_DURATION=$((ATTEMPT_END - ATTEMPT_START))
              
              # Extract components from curl output
              # Last line is response time, second to last is HTTP code
              response_time=$(echo "$curl_output" | tail -n 1)
              http_code=$(echo "$curl_output" | tail -n 2 | head -n 1)
              
              # Get response body
              if [ -f "$temp_file" ]; then
                response_body=$(cat "$temp_file" 2>/dev/null || echo "")
                rm -f "$temp_file"
              else
                response_body=""
              fi
              
              # If curl failed completely, set error code
              if [ $curl_exit_code -ne 0 ] && [ -z "$http_code" ]; then
                http_code="000"
              fi
              
              # Check if we got a successful response
              if [ "$http_code" = "200" ]; then
                echo "‚úÖ Backend responded successfully!"
                echo "üì° HTTP Status: $http_code"
                echo "‚è±Ô∏è  Response Time: ${response_time}s"
                echo "‚è±Ô∏è  Attempt Duration: ${ATTEMPT_DURATION}s"
                if [ -n "$response_body" ]; then
                  echo "üìÑ Response: $response_body"
                fi
                
                # Output metrics for summary
                echo "response_time=${response_time}" >> $GITHUB_OUTPUT
                echo "total_attempts=${attempt}" >> $GITHUB_OUTPUT
                echo "cold_start=${COLD_START}" >> $GITHUB_OUTPUT
                SUCCESS=true
                return 0
              else
                echo "‚ö†Ô∏è  Attempt $attempt failed"
                echo "üì° HTTP Status: ${http_code:-'Connection failed'}"
                echo "‚è±Ô∏è  Attempt Duration: ${ATTEMPT_DURATION}s (timeout: ${CURL_TIMEOUT}s)"
                
                # Detect cold start on first attempt timeout
                if [ $attempt -eq 1 ] && { [ "$http_code" = "000" ] || [ "$http_code" != "200" ]; }; then
                  COLD_START=true
                  echo "üßä Cold start detected - backend is spinning up from sleep"
                  echo "cold_start=true" >> $GITHUB_OUTPUT
                fi
                
                if [ -n "$response_body" ] && [ "$response_body" != "null" ]; then
                  echo "üìÑ Response: $response_body"
                fi
                
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Waiting ${delay}s before retry (linear backoff)..."
                  sleep $delay
                  TOTAL_RETRY_DELAY=$((TOTAL_RETRY_DELAY + delay))
                  delay=$((delay + DELAY_INCREMENT)) # Linear backoff: 5s, 10s, 15s, 20s
                fi
              fi
              
              attempt=$((attempt + 1))
              TOTAL_ATTEMPTS=$((TOTAL_ATTEMPTS + 1))
            done
            
            return 1
          }

          # Execute ping with retries
          if ping_with_retry; then
            WORKFLOW_END=$(date +%s)
            TOTAL_DURATION=$((WORKFLOW_END - WORKFLOW_START))
            echo ""
            echo "========================================="
            echo "‚úÖ Keep-alive ping completed successfully"
            echo "========================================="
            echo "üìä Timing Metrics:"
            echo "   Total Duration: ${TOTAL_DURATION}s"
            echo "   Total Attempts: ${TOTAL_ATTEMPTS}"
            echo "   Retry Delays: ${TOTAL_RETRY_DELAY}s"
            if [ "$COLD_START" = "true" ]; then
              echo "   Status: Cold Start (backend was sleeping)"
            else
              echo "   Status: Warm (backend was active)"
            fi
            echo "response_time_total=${TOTAL_DURATION}" >> $GITHUB_OUTPUT
            echo "retry_delays_total=${TOTAL_RETRY_DELAY}" >> $GITHUB_OUTPUT
          else
            WORKFLOW_END=$(date +%s)
            TOTAL_DURATION=$((WORKFLOW_END - WORKFLOW_START))
            echo ""
            echo "========================================="
            echo "‚ö†Ô∏è  Keep-alive ping failed after $MAX_RETRIES attempts"
            echo "========================================="
            echo "üìä Timing Metrics:"
            echo "   Total Duration: ${TOTAL_DURATION}s"
            echo "   Total Attempts: ${TOTAL_ATTEMPTS}"
            echo "   Retry Delays: ${TOTAL_RETRY_DELAY}s"
            echo "‚ÑπÔ∏è  This is likely due to a cold start timeout on Render free tier"
            echo "‚ÑπÔ∏è  The service will wake up on the next successful ping or user request"
            echo "cold_start=true" >> $GITHUB_OUTPUT
            echo "response_time_total=${TOTAL_DURATION}" >> $GITHUB_OUTPUT
            echo "retry_delays_total=${TOTAL_RETRY_DELAY}" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Backend Status: Healthy"
          echo "üèì Keep-alive ping successful"
          echo "‚è±Ô∏è  Response Time: ${{ steps.ping.outputs.response_time }}s"
          echo "‚è±Ô∏è  Total Duration: ${{ steps.ping.outputs.response_time_total }}s"
          echo "üîÑ Total Attempts: ${{ steps.ping.outputs.total_attempts }}"
          if [ "${{ steps.ping.outputs.cold_start }}" = "true" ]; then
            echo "üßä Backend Status: Cold Start (was sleeping, now awake)"
          else
            echo "üî• Backend Status: Warm (was already active)"
          fi
          echo "‚è≥ Retry Delays: ${{ steps.ping.outputs.retry_delays_total }}s"
          echo "üïê Next ping scheduled in 10 minutes"
          echo ""
          echo "The backend will remain active on Render free tier."

      - name: Alternative Notification (Rare)
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Workflow encountered an unexpected error"
          echo "‚ÑπÔ∏è  This is different from a ping timeout and may indicate:"
          echo ""
          echo "  - GitHub Actions infrastructure issue"
          echo "  - Missing or invalid BACKEND_URL secret"
          echo "  - Workflow configuration error"
          echo ""
          echo "Note: Ping timeouts no longer fail the workflow."
